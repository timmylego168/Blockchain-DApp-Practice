<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Event Listening - è€ƒé¡Œä¸‰å¯¦ä½œ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" crossorigin="anonymous"></script>
  <style>
    body { margin:0; font-family: sans-serif; background:#0b0f14; color:#e8eef7; }
    .wrap { min-height:100vh; display:grid; place-items:center; padding:24px; }
    .card { width:min(860px, 95vw); background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.14); border-radius:16px; padding:22px; }
    .mono { font-family: monospace; word-break:break-all; color: #78b4ff; }
    button { padding:12px 16px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(120,180,255,0.18); color:#e8eef7; cursor:pointer; }
    .box { margin-top:14px; padding:12px 14px; border-radius:12px; background:rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.12); font-size:14px; }
    .log { margin-top:10px; max-height:260px; overflow:auto; padding:10px; background:rgba(255,255,255,0.03); border-radius:10px; }
    .item { padding:8px; border-bottom: 1px dashed rgba(255,255,255,0.1); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ”” äº‹ä»¶ç›£è½ç®¡ç†å° (è€ƒé¡Œä¸‰)</h1>
      <div class="box">
        <div><b>åˆç´„åœ°å€</b>ï¼š<span class="mono" id="addr">å°šæœªå¡«å¯«</span></div>
        <div><b>ç‹€æ…‹</b>ï¼š<span id="status">å°šæœªé€£ç·š</span></div>
      </div>
      <div style="margin-top:14px;">
        <button id="btnDeposit">ç™¼é€ 0.001 ETH è§¸ç™¼äº‹ä»¶</button>
      </div>
      <div class="box">
        <div><b>å³æ™‚äº‹ä»¶æ—¥èªŒ (Event Log)</b>ï¼š</div>
        <div class="log" id="log"></div>
      </div>
    </div>
  </div>

<script>
  // 1. ä¿®æ”¹è™•ï¼šè«‹æ›æˆæ‚¨éƒ¨ç½²å¾Œçš„åˆç´„åœ°å€
  const contractAddress = "0x217F4a5f774A4cbEcEf2609d10ecC6852887aDD5"; 

  // 2. ä¿®æ”¹è™•ï¼šæ›´æ–° ABI ä»¥åŒ¹é… Received äº‹ä»¶
  const abi = [
    {
      "anonymous": false,
      "inputs": [
        { "indexed": true, "internalType": "address", "name": "_from", "type": "address" },
        { "indexed": false, "internalType": "uint256", "name": "_value", "type": "uint256" }
      ],
      "name": "Received",
      "type": "event"
    }
  ];

  let provider, signer, contract;

  document.getElementById("addr").textContent = contractAddress;

  function addLog(text, isEvent = false) {
    const div = document.createElement("div");
    div.className = "item";
    div.style.color = isEvent ? "#10ac84" : "#e8eef7";
    div.innerHTML = `[${new Date().toLocaleTimeString()}] ${text}`;
    document.getElementById("log").prepend(div);
  }

  async function init() {
    if (!window.ethereum) return alert("è«‹å®‰è£ MetaMask");
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    contract = new ethers.Contract(contractAddress, abi, signer);

    const account = await signer.getAddress();
    document.getElementById("status").textContent = `å·²é€£ç·šï¼š${account}`;

    // 3. ä¿®æ”¹è™•ï¼šç›£è½ Received äº‹ä»¶
    contract.on("Received", (from, value, event) => {
      const eth = ethers.utils.formatEther(value);
      addLog(`âœ¨ <b>åµæ¸¬åˆ°äº‹ä»¶ï¼</b> ä¾†è‡ªï¼š${from} | é‡‘é¡ï¼š${eth} ETH`, true);
    });

    addLog("ç³»çµ±ï¼šç›£è½å™¨å·²å•Ÿå‹•ï¼Œç­‰å¾…äº‹ä»¶ä¸­...");
  }

  // 4. ä¿®æ”¹è™•ï¼šæŒ‰éˆ•é‚è¼¯æ”¹ç‚ºç›´æ¥ç™¼é€ ETH ä»¥è§¸ç™¼ receive()
  document.getElementById("btnDeposit").onclick = async () => {
    try {
      addLog("æ­£åœ¨ç™¼èµ·è½‰å¸³ä»¥è§¸ç™¼äº‹ä»¶...");
      const tx = await signer.sendTransaction({
        to: contractAddress,
        value: ethers.utils.parseEther("0.001")
      });
      addLog(`äº¤æ˜“å·²é€å‡ºï¼ŒHash: ${tx.hash.substring(0, 16)}...`);
      await tx.wait();
      addLog("â›ï¸ äº¤æ˜“å·²ä¸Šéˆç¢ºèªã€‚");
    } catch (e) {
      addLog("âŒ äº¤æ˜“å¤±æ•—");
    }
  };

  init();
</script>
</body>
</html>