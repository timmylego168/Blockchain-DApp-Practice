<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Real-time Event Tracker - Web3 å¯¦ä½œ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" crossorigin="anonymous"></script>
  <style>
    body { margin:0; font-family: sans-serif; background:#0b0f14; color:#e8eef7; }
    .wrap { min-height:100vh; display:grid; place-items:center; padding:24px; }
    .card { width:min(860px, 95vw); background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.14); border-radius:16px; padding:22px; }
    .mono { font-family: monospace; word-break:break-all; color: #78b4ff; }
    button { padding:12px 16px; border-radius:10px; border:1px solid rgba(255,255,255,0.18); background:rgba(120,180,255,0.18); color:#e8eef7; cursor:pointer; }
    button:hover { background:rgba(120,180,255,0.28); }
    .box { margin-top:14px; padding:12px 14px; border-radius:10px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); }
    #log { max-height: 300px; overflow-y: auto; font-size: 14px; line-height: 1.6; }
    .item { margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; }
    h1 { font-size: 22px; margin-top: 0; display: flex; align-items: center; gap: 8px; }
  </style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <h1>ğŸ”” Web3 äº¤æ˜“å³æ™‚ç›£è½å¹³å° (Real-time Event Tracker)</h1>
    <p id="status" style="color:#f1c40f;">ç‹€æ…‹ï¼šå°šæœªé€£ç·š</p>

    <div class="box">
      <p><b>ç•¶å‰ç›£è½åˆç´„åœ°å€ï¼š</b><br/><span class="mono" id="contractAddr">è¼‰å…¥ä¸­...</span></p>
      <button id="btnDeposit">ç™¼é€ 0.01 ETH æ¸¬è©¦ (è§¸ç™¼ Received äº‹ä»¶)</button>
    </div>

    <div class="box" id="log">
      <div class="item">ç³»çµ±ï¼šåˆå§‹åŒ–ä¸­...</div>
    </div>
  </div>
</div>

<script>
  // 1. è«‹ç¢ºèªæ­¤è™•åœ°å€èˆ‡éƒ¨ç½²å¾Œçš„åˆç´„ä¸€è‡´
  const contractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3"; 
  
  const abi = [
    "event Received(address indexed from, uint256 value)",
    "function deposit() public payable",
    "receive() external payable"
  ];

  let provider, signer, contract;
  document.getElementById("contractAddr").textContent = contractAddress;

  function addLog(text, isEvent = false) {
    const div = document.createElement("div");
    div.className = "item";
    div.style.color = isEvent ? "#10ac84" : "#e8eef7";
    div.innerHTML = `[${new Date().toLocaleTimeString()}] ${text}`;
    document.getElementById("log").prepend(div);
  }

  async function init() {
    if (!window.ethereum) return alert("è«‹å®‰è£ MetaMask");
    try {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      contract = new ethers.Contract(contractAddress, abi, signer);

      const account = await signer.getAddress();
      document.getElementById("status").textContent = `å·²é€£ç·šï¼š${account}`;
      document.getElementById("status").style.color = "#10ac84";

      // ç›£è½ Received äº‹ä»¶
      contract.on("Received", (from, value, event) => {
        const eth = ethers.utils.formatEther(value);
        addLog(`âœ¨ <b>åµæ¸¬åˆ°éˆä¸Šäº‹ä»¶ï¼</b> ä¾†è‡ªï¼š${from} | é‡‘é¡ï¼š${eth} ETH`, true);
      });

      addLog("ç³»çµ±ï¼šç›£è½å™¨å·²å•Ÿå‹•ï¼Œæ­£åœ¨è¿½è¹¤å€å¡Šéˆäº‹ä»¶...");
    } catch (error) {
      addLog("ç³»çµ±éŒ¯èª¤ï¼š" + error.message);
    }
  }

  document.getElementById("btnDeposit").onclick = async () => {
    try {
      addLog("ç™¼é€ä¸­... è«‹åœ¨ MetaMask ç¢ºèªäº¤æ˜“");
      const tx = await signer.sendTransaction({
        to: contractAddress,
        value: ethers.utils.parseEther("0.01")
      });
      addLog(`äº¤æ˜“å·²é€å‡ºï¼ŒHash: ${tx.hash.substring(0,20)}...`);
      await tx.wait();
      addLog("äº¤æ˜“å·²ä¸Šéˆç¢ºèªï¼");
    } catch (err) {
      addLog("å¤±æ•—ï¼š" + err.message);
    }
  };

  init();
</script>

</body>
</html>